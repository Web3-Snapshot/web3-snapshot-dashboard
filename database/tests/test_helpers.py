import pytest
from util.helpers import (
    compute_extra_columns,
    generate_object_diff,
    process_percentages,
)


@pytest.fixture
def coin_data():
    return [
        {
            "prop1": 10.0,  # Different signs should generate two independent list
            "prop2": -4.00,  # Same, signs inverted
            "prop3": 16.0,  # One value is `None'; it should be set to 0
            "prop4": -1,  # All values are equal, they should all have a 100% assigned
            "prop5": 144,  # Should not be considered since it is not in the keys list
        },
        {
            "prop1": 100.0,
            "prop2": -8.00,
            "prop3": None,
            "prop4": -1,
            "prop5": 200,
        },
        {"prop1": -100.0, "prop2": 1234.00, "prop3": 4.0, "prop4": -1, "prop5": 400},
    ]


def test_process_percentages(coin_data):
    expected_output = [
        {
            "prop1": 10.0,
            "prop1_relative": 10,
            "prop2": -4.0,
            "prop2_relative": 50,
            "prop3": 16.0,
            "prop3_relative": 100,
            "prop4": -1,
            "prop4_relative": 100,
            "prop5": 144,
        },
        {
            "prop1": 100.0,
            "prop1_relative": 100,
            "prop2": -8.0,
            "prop2_relative": 100,
            "prop3": None,
            "prop3_relative": 0,
            "prop4": -1,
            "prop4_relative": 100,
            "prop5": 200,
        },
        {
            "prop1": -100.0,
            "prop1_relative": 100,
            "prop2": 1234.0,
            "prop2_relative": 100,
            "prop3": 4.0,
            "prop3_relative": 25,
            "prop4": -1,
            "prop4_relative": 100,
            "prop5": 400,
        },
    ]

    assert (
        process_percentages(
            coin_data,
            ["prop1", "prop2", "prop3", "prop4"],
        )
        == expected_output
    )


def test_compute_extra_columns():
    expected = [
        {
            "market_cap": 428569062162,
            "fully_diluted_valuation": 466538642853,
            "circulating_supply": 251816.736,
            "total_supply": 251816.736,
            "mc_fdv_ratio": 0.919,
            "circ_supply_total_supply_ratio": 1.0,
        },
        {
            "market_cap": 188109860328,
            "fully_diluted_valuation": 188109860328,
            "mc_fdv_ratio": 1.0,
            "circ_supply_total_supply_ratio": None,
        },
    ]

    input_data = [
        {
            "market_cap": 428569062162,
            "fully_diluted_valuation": 466538642853,
            "circulating_supply": 251816.736,
            "total_supply": 251816.736,
        },
        {
            "market_cap": 188109860328,
            "fully_diluted_valuation": 188109860328,
        },
    ]
    assert expected == compute_extra_columns(input_data)


def test_generate_diff_all_equal():
    previous_data = [
        {
            "id": "bitcoin",
            "symbol": "btc",
            "name": "Bitcoin",
            "image": "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
            "current_price": 27300,
            "market_cap": 533052722379,
            "market_cap_rank": 1,
            "fully_diluted_valuation": 573962971793,
            "total_volume": 14118300117,
            "high_24h": 27952,
            "low_24h": 27298,
            "price_change_24h": -628.0742902898564,
            "price_change_percentage_24h": -2.24893,
            "market_cap_change_24h": -9809299387.1745,
            "market_cap_change_percentage_24h": -1.80696,
            "circulating_supply": 19503187,
            "total_supply": 21000000,
            "max_supply": 21000000,
            "ath": 69045,
            "ath_change_percentage": -60.45222,
            "ath_date": "2021-11-10T14:24:11.849Z",
            "atl": 67.81,
            "atl_change_percentage": 40168.5088,
            "atl_date": "2013-07-06T00:00:00.000Z",
            "roi": None,
            "last_updated": "2023-10-03T19:52:20.363Z",
            "price_change_percentage_1h_in_currency": -0.1564735720678735,
            "price_change_percentage_24h_in_currency": -2.248931288518162,
            "price_change_percentage_7d_in_currency": 4.360420461311904,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
        {
            "id": "ethereum",
            "symbol": "eth",
            "name": "Ethereum",
            "image": "https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880",
            "current_price": 1650.72,
            "market_cap": 198753605141,
            "market_cap_rank": 2,
            "fully_diluted_valuation": 198753605141,
            "total_volume": 8474747145,
            "high_24h": 1672.53,
            "low_24h": 1644.94,
            "price_change_24h": -20.278674989203864,
            "price_change_percentage_24h": -1.21357,
            "market_cap_change_24h": -1657243817.8083801,
            "market_cap_change_percentage_24h": -0.82692,
            "circulating_supply": 120240729.475341,
            "total_supply": 120240729.475341,
            "max_supply": None,
            "ath": 4878.26,
            "ath_change_percentage": -66.14014,
            "ath_date": "2021-11-10T14:24:19.604Z",
            "atl": 0.432979,
            "atl_change_percentage": 381390.20484,
            "atl_date": "2015-10-20T00:00:00.000Z",
            "roi": {
                "times": 79.83303376356373,
                "currency": "btc",
                "percentage": 7983.3033763563735,
            },
            "last_updated": "2023-10-03T19:52:16.274Z",
            "price_change_percentage_1h_in_currency": -0.04567413423321346,
            "price_change_percentage_24h_in_currency": -1.2135652299447584,
            "price_change_percentage_7d_in_currency": 4.211730460182393,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
    ]
    current_data = [
        {
            "id": "bitcoin",
            "symbol": "btc",
            "name": "Bitcoin",
            "image": "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
            "current_price": 27300,
            "market_cap": 533052722379,
            "market_cap_rank": 1,
            "fully_diluted_valuation": 573962971793,
            "total_volume": 14118300117,
            "high_24h": 27952,
            "low_24h": 27298,
            "price_change_24h": -628.0742902898564,
            "price_change_percentage_24h": -2.24893,
            "market_cap_change_24h": -9809299387.1745,
            "market_cap_change_percentage_24h": -1.80696,
            "circulating_supply": 19503187,
            "total_supply": 21000000,
            "max_supply": 21000000,
            "ath": 69045,
            "ath_change_percentage": -60.45222,
            "ath_date": "2021-11-10T14:24:11.849Z",
            "atl": 67.81,
            "atl_change_percentage": 40168.5088,
            "atl_date": "2013-07-06T00:00:00.000Z",
            "roi": None,
            "last_updated": "2023-10-03T19:52:20.363Z",
            "price_change_percentage_1h_in_currency": -0.1564735720678735,
            "price_change_percentage_24h_in_currency": -2.248931288518162,
            "price_change_percentage_7d_in_currency": 4.360420461311904,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
        {
            "id": "ethereum",
            "symbol": "eth",
            "name": "Ethereum",
            "image": "https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880",
            "current_price": 1650.72,
            "market_cap": 198753605141,
            "market_cap_rank": 2,
            "fully_diluted_valuation": 198753605141,
            "total_volume": 8474747145,
            "high_24h": 1672.53,
            "low_24h": 1644.94,
            "price_change_24h": -20.278674989203864,
            "price_change_percentage_24h": -1.21357,
            "market_cap_change_24h": -1657243817.8083801,
            "market_cap_change_percentage_24h": -0.82692,
            "circulating_supply": 120240729.475341,
            "total_supply": 120240729.475341,
            "max_supply": None,
            "ath": 4878.26,
            "ath_change_percentage": -66.14014,
            "ath_date": "2021-11-10T14:24:19.604Z",
            "atl": 0.432979,
            "atl_change_percentage": 381390.20484,
            "atl_date": "2015-10-20T00:00:00.000Z",
            "roi": {
                "times": 79.83303376356373,
                "currency": "btc",
                "percentage": 7983.3033763563735,
            },
            "last_updated": "2023-10-03T19:52:16.274Z",
            "price_change_percentage_1h_in_currency": -0.04567413423321346,
            "price_change_percentage_24h_in_currency": -1.2135652299447584,
            "price_change_percentage_7d_in_currency": 4.211730460182393,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
    ]
    expected_diff = []
    assert generate_object_diff(previous_data, current_data) == expected_diff


def test_generate_diff_one_different():
    previous_data = [
        {
            "id": "bitcoin",
            "symbol": "btc",
            "name": "Bitcoin",
            "image": "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
            "current_price": 27300,
            "market_cap": 533052722379,
            "market_cap_rank": 1,
            "fully_diluted_valuation": 573962971793,
            "total_volume": 14118300117,
            "high_24h": 27952,
            "low_24h": 27298,
            "price_change_24h": -628.0742902898564,
            "price_change_percentage_24h": -2.24893,
            "market_cap_change_24h": -9809299387.1745,
            "market_cap_change_percentage_24h": -1.80696,
            "circulating_supply": 19503187,
            "total_supply": 21000000,
            "max_supply": 21000000,
            "ath": 69045,
            "ath_change_percentage": -60.45222,
            "ath_date": "2021-11-10T14:24:11.849Z",
            "atl": 67.81,
            "atl_change_percentage": 40168.5088,
            "atl_date": "2013-07-06T00:00:00.000Z",
            "roi": None,
            "last_updated": "2023-10-03T19:52:20.363Z",
            "price_change_percentage_1h_in_currency": -0.1564735720678735,
            "price_change_percentage_24h_in_currency": -2.248931288518162,
            "price_change_percentage_7d_in_currency": 4.360420461311904,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
        {
            "id": "ethereum",
            "symbol": "eth",
            "name": "Ethereum",
            "image": "https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880",
            "current_price": 1650.72,
            "market_cap": 198753605141,
            "market_cap_rank": 2,
            "fully_diluted_valuation": 198753605141,
            "total_volume": 8474747145,
            "high_24h": 1672.53,
            "low_24h": 1644.94,
            "price_change_24h": -20.278674989203864,
            "price_change_percentage_24h": -1.21357,
            "market_cap_change_24h": -1657243817.8083801,
            "market_cap_change_percentage_24h": -0.82692,
            "circulating_supply": 120240729.475341,
            "total_supply": 120240729.475341,
            "max_supply": None,
            "ath": 4878.26,
            "ath_change_percentage": -66.14014,
            "ath_date": "2021-11-10T14:24:19.604Z",
            "atl": 0.432979,
            "atl_change_percentage": 381390.20484,
            "atl_date": "2015-10-20T00:00:00.000Z",
            "roi": {
                "times": 79.83303376356373,
                "currency": "btc",
                "percentage": 7983.3033763563735,
            },
            "last_updated": "2023-10-03T19:52:16.274Z",
            "price_change_percentage_1h_in_currency": -0.04567413423321346,
            "price_change_percentage_24h_in_currency": -1.2135652299447584,
            "price_change_percentage_7d_in_currency": 4.211730460182393,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
    ]
    current_data = [
        {
            "id": "bitcoin",
            "symbol": "btc",
            "name": "Bitcoin",
            "image": "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
            "current_price": 27300,
            "market_cap": 533052722379,
            "market_cap_rank": 1,
            "fully_diluted_valuation": 573962971793,
            "total_volume": 14118300117,
            "high_24h": 27952,
            "low_24h": 27298,
            # "price_change_24h": -628.0742902898564,
            "price_change_24h": -628.1242902898564,  # Only this value changed
            "price_change_percentage_24h": -2.24893,
            "market_cap_change_24h": -9809299387.1745,
            "market_cap_change_percentage_24h": -1.80696,
            "circulating_supply": 19503187,
            "total_supply": 21000000,
            "max_supply": 21000000,
            "ath": 69045,
            "ath_change_percentage": -60.45222,
            "ath_date": "2021-11-10T14:24:11.849Z",
            "atl": 67.81,
            "atl_change_percentage": 40168.5088,
            "atl_date": "2013-07-06T00:00:00.000Z",
            "roi": None,
            "last_updated": "2023-10-03T19:52:20.363Z",
            "price_change_percentage_1h_in_currency": -0.1564735720678735,
            "price_change_percentage_24h_in_currency": -2.248931288518162,
            "price_change_percentage_7d_in_currency": 4.360420461311904,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
        {
            "id": "ethereum",
            "symbol": "eth",
            "name": "Ethereum",
            "image": "https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880",
            "current_price": 1650.72,
            "market_cap": 198753605141,
            "market_cap_rank": 2,
            "fully_diluted_valuation": 198753605141,
            "total_volume": 8474747145,
            "high_24h": 1672.53,
            "low_24h": 1644.94,
            "price_change_24h": -20.278674989203864,
            "price_change_percentage_24h": -1.21357,
            "market_cap_change_24h": -1657243817.8083801,
            "market_cap_change_percentage_24h": -0.82692,
            "circulating_supply": 120240729.475341,
            "total_supply": 120240729.475341,
            "max_supply": None,
            "ath": 4878.26,
            "ath_change_percentage": -66.14014,
            "ath_date": "2021-11-10T14:24:19.604Z",
            "atl": 0.432979,
            "atl_change_percentage": 381390.20484,
            "atl_date": "2015-10-20T00:00:00.000Z",
            "roi": {
                "times": 79.83303376356373,
                "currency": "btc",
                "percentage": 7983.3033763563735,
            },
            "last_updated": "2023-10-03T19:52:16.274Z",
            "price_change_percentage_1h_in_currency": -0.04567413423321346,
            "price_change_percentage_24h_in_currency": -1.2135652299447584,
            "price_change_percentage_7d_in_currency": 4.211730460182393,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
    ]
    expected_diff = [
        {
            "id": "bitcoin",
            "symbol": "btc",
            "name": "Bitcoin",
            "image": "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
            "current_price": 27300,
            "market_cap": 533052722379,
            "market_cap_rank": 1,
            "fully_diluted_valuation": 573962971793,
            "total_volume": 14118300117,
            "high_24h": 27952,
            "low_24h": 27298,
            "price_change_24h": -628.1242902898564,  # We get the item with the changed value
            "price_change_percentage_24h": -2.24893,
            "market_cap_change_24h": -9809299387.1745,
            "market_cap_change_percentage_24h": -1.80696,
            "circulating_supply": 19503187,
            "total_supply": 21000000,
            "max_supply": 21000000,
            "ath": 69045,
            "ath_change_percentage": -60.45222,
            "ath_date": "2021-11-10T14:24:11.849Z",
            "atl": 67.81,
            "atl_change_percentage": 40168.5088,
            "atl_date": "2013-07-06T00:00:00.000Z",
            "roi": None,
            "last_updated": "2023-10-03T19:52:20.363Z",
            "price_change_percentage_1h_in_currency": -0.1564735720678735,
            "price_change_percentage_24h_in_currency": -2.248931288518162,
            "price_change_percentage_7d_in_currency": 4.360420461311904,
            "price_change_percentage_30d_in_currency": 5.360420461311904,
            "price_change_percentage_1y_in_currency": 6.360420461311904,
        },
    ]
    assert generate_object_diff(previous_data, current_data) == expected_diff
